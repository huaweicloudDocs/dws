# 扩容集群<a name="dws_01_0023"></a>

随着您的数据仓库容量和性能需求的变化，您可以在管理控制台调整已有集群的大小，以便充分利用GaussDB\(DWS\) 提供的计算资源和存储资源。

-   对于集群版本在1.5.0以下的集群，只支持通过增加新节点来扩大集群容量，且新增加的节点规格与集群原节点的规格相同。具体操作步骤请参见[扩容集群](#section31992607155626)。

>![](public_sys-resources/icon-note.gif) **说明：** 
>新增的节点默认是按需计费。用户可以再购买和新增节点个数和规格相同的包年包月套餐节点，这样新的节点也可以按照优惠价格收费。

如果您是因集群存储容量不足而扩容集群，建议您在扩容前先执行vacuum清理和回收存储空间，GaussDB\(DWS\) 数据仓库中保存的数据在删除后，可能没有释放占用的磁盘空间形成脏数据，导致磁盘浪费。如果执行vacuum后，已使用存储容量仍然占用过高，您再进行扩容。VACUUM的语法请参见《数据仓库服务数据库开发指南》中的[VACUUM](https://support.huaweicloud.com/devg-dws/vacuum.html)章节。

## 扩容对系统的影响<a name="section60787995155336"></a>

-   扩容前，需退出创建了临时表的客户端连接，因为在扩容过程中及扩容成功之前创建的临时表将会失效，操作临时表也会失败。但是，扩容后创建的临时表不受影响。
-   在执行“扩容“操作后，集群会进行一次自动快照，快照创建成功后进行集群扩容。
-   正在扩容的集群将禁用重启集群、扩容集群、创建快照、重置集群管理员密码和删除集群的功能。
-   扩容过程中，集群会自动重启，因此集群会有一段时间变为“不可用“状态，重启成功后集群变回“可用“状态。然后，在扩容结束阶段，系统会将集群中用户数据在全部节点重新动态分布。
-   在离线扩容（重分布read-only模式）过程中，用户应该停止所有业务或运行少量查询语句。表重分布期间会对表加共享锁，所有插入、更新、删除操作和表DDL操作都会长时间阻塞，可能会等锁超时。一旦表重分布完成，用户可以正常访问该表。在重分布执行过程中，用户应当避免执行超过20分钟的查询（在重分布执行时申请写锁的默认时间为20分钟）。否则可能导致重分布出现等待加锁超时失败的问题。
-   在线扩容（重分布insert模式）过程中，表重分布期间用户可以对该表执行插入、更新、删除，但重分布过程仍然会短时间阻塞用户的数据更新操作，会影响用户语句的执行性能。扩容重分布过程会消耗大量的CPU和IO资源，因此会对用户作业性能影响较大，用户应该尽可能在停止业务情况下或业务轻载的情况下执行扩容重分布。用户也可以考虑分段扩容重分布策略，在系统负载很小的情况下采用高并发进行扩容重分布，在系统负载大的情况下停止扩容重分布或采用低并发进行扩容重分布。
-   扩容后，如果集群创建新快照，将包含扩容节点上的数据。
-   如果集群扩容失败，数据库会在后台自动执行扩容回滚操作，集群会恢复到扩容前的节点个数。
    -   如果回滚成功，集群仍可以正常使用，用户可以重新执行“扩容“操作，如果仍扩容失败，请及时联系技术支持人员进行处理。
    -   如果数据库因为某些异常原因后台回滚失败，则集群可能会变为“不可用“状态，此时无法再执行“扩容“或重启集群的操作，请及时联系技术支持人员进行处理。

    -   扩容重分布过程中\(包括read-only和insert模式），不支持创建、修改、删除数据库和表空间。

    -   read-only模式（离线模式）的扩容过程中，数据库不支持DDL和DCL操作，正在重分布的表只支持DQL操作，insert模式（在线模式）的扩容过程中，数据库支持部分DDL和DCL操作。
    -   insert模式（在线模式）下在重分布的表支持插入、删除、更新和部分DDL，支持的功能为：
        -   重分布过程中用户可进行正在重分布的本地表的INSERT、DELETE、UPDATE、MERGE INTO业务。
        -   重分布过程中用户可进行正在重分布的本地表跨节点组的关联查询业务。
        -   重分布过程中用户可进行正在重分布的本地表的DROP、TRUNCATE、TRUNCATE-PARTITION业务。

    -   insert模式（在线模式）下正在重分布的本地表不支持如下功能：
        -   表正在重分布过程中用户不能执行ALTER TABLE语句，典型的包括增加、删除字段，重命名，修改schema，但TRUNCATE PARTITION除外。
        -   表正在重分布过程中用户不能创建、修改、删除索引。
        -   表正在重分布过程中用户不能对该表执行vacuum full和cluster语句。
        -   表正在重分布过程中用户不能修改字段依赖的SEQUENCE对象，包括创建和修改字段依赖的SEQUENCE对象，典型的语句是CREATE/ALTER SEQUENCE ... OWNED BY。



## 前提条件<a name="section6414583815542"></a>

-   请确定需要扩容的集群处于“可用“、“只读“或者“低性能“任意一种状态。
-   请确定计划扩容的节点数小于等于用户节点数的剩余配额，否则系统会提示无法进行扩容操作。用户可使用的节点数可在“集群管理“页面查看。

## 扩容集群<a name="section31992607155626"></a>

>![](public_sys-resources/icon-note.gif) **说明：** 
>-   扩容期间集群将变为只读状态，请谨慎操作。
>-   为保证您的数据安全我们建议您在开始扩容操作之前创建手动快照。如何创建快照请参见[手动创建快照](手动创建快照.md)。

对于集群版本在1.5.0以下的集群，目前只支持通过增加新节点来扩大集群容量，详细操作步骤如下：

1.  登录GaussDB\(DWS\) 管理控制台。
2.  单击“集群管理“。

    默认显示用户所有的集群列表。

3.  在集群列表中，在指定集群所在行的“操作“列，选择“更多  \>  扩容“。

    系统将显示扩容页面。

    **图 1**  扩容集群<a name="fig1487919248111"></a>  
    ![](figures/扩容集群.png "扩容集群")

4.  在“扩容到“选择一个扩容后的节点数。
    -   扩容后的节点数量，在原节点数量的基础上，须至少增加3个节点，最多可增加的节点个数为节点剩余配额的最大值。并且，此处设置的扩容后的节点数量不能超过32个节点。

        如果可使用的节点配额不足，用户可以单击“申请更多配额“以提工单的形式申请更多节点配额。

        如果有符合业务需求的包年包月套餐的节点，建议先使用包年包月套餐节点，可以节约费用。如果没有，可以单击“购买包年包月套餐“进行购买。

    -   扩容增加的节点规格，默认与集群当前各节点的规格相同。
    -   扩容后的集群与原集群的虚拟私有云、子网和安全组也相同。

5.  单击“立即申请“。
6.  单击“提交“。
    -   提交扩容申请后，集群的“任务信息“显示为“节点扩容“，扩容需要时间请耐心等待。扩容过程中，集群会自动重启，因此会有一段时间“集群状态“显示为“不可用“，重启成功后“集群状态“会变成“可用“。然后，在扩容结束阶段，集群将重新分布数据，重分布过程中“集群状态“为“只读“。
    -   只有“集群状态“显示为“可用“且“任务信息“显示的“节点扩容“状态结束，才表示扩容成功，用户可以开始使用集群。
    -   如果集群的“任务信息“显示为“扩容失败“，表示集群扩容失败。


